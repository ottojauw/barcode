<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barcode Display</title>
    <style>
        .barcode-png {
            display: block;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <img class="barcode-png" style="display: block;" alt="Barcode" id="barcodeImage">

    <script>
        window.onload = async function() {
            // Get barcode text from query parameter
            const urlParams = new URLSearchParams(window.location.search);
            const text = urlParams.get('text');
            const format = urlParams.get('format') || '';
            const width = urlParams.get('width') || '';
            const height = urlParams.get('height') || '';

            if (!text) {
                document.body.innerHTML = '<p>Error: Missing text parameter</p>';
                return;
            }

            try {
                // Build API URL
                const apiUrl = window.location.origin + window.location.pathname.replace('barcode_display', 'barcode_api');
                let apiCallUrl = apiUrl + '?text=' + encodeURIComponent(text);
                
                if (format) apiCallUrl += '&format=' + encodeURIComponent(format);
                if (width) apiCallUrl += '&width=' + encodeURIComponent(width);
                if (height) apiCallUrl += '&height=' + encodeURIComponent(height);

                // Fetch from API
                const response = await fetch(apiCallUrl);
                const html = await response.text();
                
                // Extract JSON from the HTML response
                const preStart = html.indexOf('<pre>');
                const preEnd = html.indexOf('</pre>');
                const jsonText = html.substring(preStart + 5, preEnd);
                
                console.log("returned jsonText:", jsonText);
                
                // Parse JSON
                const data = JSON.parse(jsonText);

                if (data.error) {
                    document.body.innerHTML = '<p>Error: ' + data.error + '</p>';
                    return;
                }

                // Display the barcode image
                document.getElementById('barcodeImage').src = data.image;

            } catch (e) {
                document.body.innerHTML = '<p>Error: ' + e.message + '</p>';
            }
        };
    </script>
</body>
</html>